---
title: "Respirometry data analysis C. Fleming Last updated: 12/8/22"
output:
  pdf_document: default
  html_notebook: default
authors: Caroline Fleming

#Some resources:
  #https://rstudio-pubs-static.s3.amazonaws.com/63556_e35cc7e2dfb54a5bb551f3fa4b3ec4ae.html

---

```{r Setting up all packages}
require("knitr")
#install.packages("lme4")
#compare with and without predictor
#library(lme4)
#install.packages("lmerTest")
library("lmerTest")
#install.packages("Matrix")
library("Matrix")
#install.packages("lme4")
library("lme4")
#install.packages("emmeans")
library("emmeans")
#install.packages("pbkrtest")
library("pbkrtest")
library("tidyverse")
library("performance")
#install.packages("see")
library("see")
#install.packages("ggrepel")
library("ggrepel")
#install.packages("sjPlot") #for visualizing linear models
library(sjPlot)

```


```{r Set working directory and upload data}
opts_knit$set(root.dir = "C:/Users/carol/Documents/PhD Boston University 2019-/Chapter_2_Ecotox/Summer_2022_N_Ecotox")
getwd()
resp_all.data <- read.csv("RESP_ALL_SUMMARY_12_8_22.csv", header=TRUE, sep=",",stringsAsFactors = FALSE)

hist(resp_all.data$resp_rate)
qqnorm(resp_all.data$resp_rate)

#make sure treatID is a character
resp_all.data$treat_ID<-as.character(resp_all.data$treat_ID)

#adding a log transformed resp rate
resp_all.data$log_resp_rate<-abs(resp_all.data$resp_rate)
resp_all.data$log_resp_rate<-log(resp_all.data$log_resp_rate)
resp_all.data$arcsin_resp_rate<-asin(resp_all.data$resp_rate)

#testing for normality
#TESTING FOR NORMALITY IN PAM_delta
#install new package to see what the best transformation is
#install.packages("bestNormalize")
library("bestNormalize")
bestNormalize(resp_all.data$resp_rate)
#in order for this to work I need to change the PAM_delta in to a vector
resp_all.data$resp_rate_vector<-as.vector(resp_all.data$resp_rate_vector)
#then I run the orderNorm command into a new object
orderNormobj_resp_rate<-orderNorm(resp_all.data$resp_rate)
#this object gives us what we want, but we have to index from that object and put it in a new column
resp_all.data$ordernorm_resp_rate<-orderNormobj_resp_rate$x.t
```



```{r linear models}
mm_resp_null <- lmer(resp_rate ~ 1 + (1|vial_ID), data= resp_all.data)
summary(mm_resp_null)
#that null looks good

mm_resp_1 <- lmer(resp_rate ~ N_species + N_dose + temp + food + sym_state + e_coli_plate + (1|vial_ID), data= resp_all.data)
summary(mm_resp_1)
# the factors that are not significant and I will drop: Nspecies, food

mm_resp_2 <- lmer(resp_rate ~ N_dose + + N_species + temp + sym_state + e_coli_plate + (1|vial_ID), data= resp_all.data)
summary(mm_resp_2)
emm_resp_2=emmeans(mm_resp_2, specs=pairwise ~ N_species)
summary(emm_resp_2)

#checking out where the changes are
all_20C<-subset(resp_all.data, resp_all.data$temp==20)
all_30C<-subset(resp_all.data, resp_all.data$temp==30)
all_apo<-subset(resp_all.data, resp_all.data$sym_state=="A")
all_sym<-subset(resp_all.data, resp_all.data$sym_state=="S")
all_e_coli<-subset(resp_all.data, resp_all.data$e_coli_plate=="1")
all_no_e_coli<-subset(resp_all.data, resp_all.data$e_coli_plate=="0")

mean(all_20C$resp_rate, na.rm=TRUE)
# -0.004676263
mean(all_30C$resp_rate, na.rm=TRUE)
# -0.004191459
mean(all_apo$resp_rate, na.rm=TRUE)
# -0.004231038
mean(all_sym$resp_rate, na.rm=TRUE)
# -0.004632639
mean(all_e_coli$resp_rate, na.rm=TRUE)
# -0.004617116
mean(all_no_e_coli$resp_rate, na.rm=TRUE)
# -0.004230682

mm_resp_3 <- lmer(resp_rate ~ N_dose  + temp + sym_state + e_coli_plate + N_dose*temp + N_dose*sym_state + sym_state*temp + (1|vial_ID), data= resp_all.data)
summary(mm_resp_3)

mm_resp_4 <- lmer(resp_rate ~ N_dose  + temp + sym_state + e_coli_plate +  N_dose*sym_state + sym_state*temp + (1|vial_ID), data= resp_all.data)
summary(mm_resp_4)

mm_resp_5 <- lmer(resp_rate ~ N_dose  + temp + sym_state + e_coli_plate + sym_state*temp + (1|vial_ID), data= resp_all.data)
summary(mm_resp_5)

mm_resp_6 <- lmer(resp_rate ~ N_dose  + temp + sym_state + e_coli_plate +  N_dose*sym_state + (1|vial_ID), data= resp_all.data)
summary(mm_resp_6)

#AIC 
AIC_table_pam<-AIC(mm_resp_1, mm_resp_2, mm_resp_3, mm_resp_4, mm_resp_5, mm_resp_6)
AIC_table_pam

#lower AIC wins, mm_resp_2 wins
```


```{r linear models}
#posthoc pairwise
#need to change the max print because we have so many comparisons
options(max.print = 10000)   
emm_treat_ID=emmeans(mm_resp_treat, specs=pairwise ~ treat_ID)
summary(emm_treat_ID)

#checking for model fit
plot(mm_resp_treat) #homogeneity of variance,looks okay
r2(mm_resp_treat) #marginal id variance just by fixed factors, conditional includes variance explained by random factor
  # treatment explains 9.5% of variation in ln.sum.arms
?check_model()
str(larvae.data)
check_collinearity(mm_resp_treat) #check for predictor variables are correlated
#check_model(mm_resp_treat)
check_outliers(mm_resp_treat)
check_heteroscedasticity(mm_resp_treat)
check_homogeneity(mm_resp_treat) #plot
check_autocorrelation(mm_resp_treat) #plot

plot(mm_resp_treat)
```






```{r T TEST FOR UROP}
control_all_20<-subset(resp_all.data, resp_all.data$N_dose=="0" & resp_all.data$temp=="20")
control_ecoli_20<-subset(resp_all.data, resp_all.data$N_dose=="0" & resp_all.data$temp=="20" & resp_all.data$e_coli=="1")
control_no_ecoli_20<-subset(resp_all.data, resp_all.data$N_dose=="0" & resp_all.data$temp=="20" & resp_all.data$e_coli=="0")
control_all_30<-subset(resp_all.data, resp_all.data$N_dose=="0" & resp_all.data$temp=="30")
control_ecoli_30<-subset(resp_all.data, resp_all.data$N_dose=="0" & resp_all.data$temp=="30" & resp_all.data$e_coli=="1")
control_no_ecoli_30<-subset(resp_all.data, resp_all.data$N_dose=="0" & resp_all.data$temp=="30" & resp_all.data$e_coli=="0")
A_5_20 <-subset(resp_all.data, resp_all.data$N_species=="A"& resp_all.data$N_dose=="5" & resp_all.data$temp=="20")
A_5_30 <- A_5_20 <-subset(resp_all.data, resp_all.data$N_species=="A"& resp_all.data$N_dose=="5" & resp_all.data$temp=="30")
A_7.5_20 <-subset(resp_all.data, resp_all.data$N_species=="A"& resp_all.data$N_dose=="7.5" & resp_all.data$temp=="20")
A_7.5_30 <- A_5_20 <-subset(resp_all.data, resp_all.data$N_species=="A"& resp_all.data$N_dose=="7.5" & resp_all.data$temp=="30")
A_10_20 <-subset(resp_all.data, resp_all.data$N_species=="A"& resp_all.data$N_dose=="10" & resp_all.data$temp=="20")
A_10_30 <- A_5_20 <-subset(resp_all.data, resp_all.data$N_species=="A"& resp_all.data$N_dose=="10" & resp_all.data$temp=="30")
N_1.5_20 <-subset(resp_all.data, resp_all.data$N_species=="N"& resp_all.data$N_dose=="1.5" & resp_all.data$temp=="20")
N_1.5_30 <- A_5_20 <-subset(resp_all.data, resp_all.data$N_species=="N"& resp_all.data$N_dose=="1.5" & resp_all.data$temp=="30")
N_5_20 <-subset(resp_all.data, resp_all.data$N_species=="N"& resp_all.data$N_dose=="5" & resp_all.data$temp=="20")
N_5_30 <- A_5_20 <-subset(resp_all.data, resp_all.data$N_species=="N"& resp_all.data$N_dose=="5" & resp_all.data$temp=="30")
N_18_20 <-subset(resp_all.data, resp_all.data$N_dose=="18" & resp_all.data$temp=="20")
N_18_30 <-subset(resp_all.data, resp_all.data$N_dose=="18" & resp_all.data$temp=="30")
e_coli<-subset(resp_all.data, resp_all.data$e_coli==1)
no_e_coli<-subset(resp_all.data, resp_all.data$e_coli==0)
N_18_30_e_coli <-subset(resp_all.data, resp_all.data$N_dose=="18" & resp_all.data$temp=="30" & resp_all.data$e_coli==1)

#e coli controls
t.test(control_ecoli_30$resp_rate, control_no_ecoli_30$resp_rate)


#means of e coli vs no e coli
mean(e_coli$resp_rate)
#-0.00445
mean(no_e_coli$resp_rate)
#-0.003760578

# Control 20 v control 30
t.test(control_all_20$resp_rate, control_all_30$resp_rate)
# A 5 20 v A 5 30
t.test(A_5_20$resp_rate, A_5_30$resp_rate)
# A 7.5 20 v A 7.5 30
t.test(A_7.5_20$resp_rate, A_7.5_30$resp_rate)
# Control 20 v. A10 20
t.test(control_all_20$resp_rate, A_10_20$resp_rate)
# Control 30 v. A10 30
t.test(control_all_30$resp_rate, A_10_30$resp_rate)
# A10 20 v A10 30
t.test(A_10_20$resp_rate, A_10_30$resp_rate)
# N 1.5 20 v N 1.5 30
t.test(N_1.5_20$resp_rate, N_1.5_30$resp_rate)
# N 5 20 v N 5 30
t.test(N_5_20$resp_rate, N_5_30$resp_rate)
# Control 20 v. N18 20
t.test(control_all_20$resp_rate, N_18_20$resp_rate)
# Control 30 v. Control N18 30
t.test(control_all_30$resp_rate, N_18_30$resp_rate)

# e coli vs. no ecoli 
t.test(e_coli$resp_rate, no_e_coli$resp_rate)
# N 18 e coli 30 vs. control 30
t.test(control_all_30$resp_rate, N_18_30_e_coli$resp_rate)
       
```
